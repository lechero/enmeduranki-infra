services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: kingkontext-nl-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-strapi}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: ${POSTGRES_USER:-strapi}
    healthcheck:
      interval: 10s
      retries: 5
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-strapi}"]
      timeout: 5s
    networks:
      - kingkontext-nl-internal
    restart: unless-stopped
    volumes:
      - postgres-data:/var/lib/postgresql/data

  # Strapi CMS (headless CMS backend)
  cms:
    image: ${REGISTRY_BASE_URL}kingkontext-nl-cms:latest
    # build:
    #   args:
    #     NODE_ENV: production
    #   context: ${APP_CODE_PATH}
    #   dockerfile: apps/cms/Dockerfile
    container_name: kingkontext-nl-cms
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - .env
    environment:
      ADMIN_JWT_SECRET: ${ADMIN_JWT_SECRET}
      API_TOKEN_SALT: ${API_TOKEN_SALT}
      APP_KEYS: ${APP_KEYS}
      DATABASE_CLIENT: postgres
      DATABASE_HOST: postgres
      DATABASE_NAME: ${POSTGRES_DB:-strapi}
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD}
      DATABASE_PORT: 5432
      DATABASE_SSL: false
      DATABASE_USERNAME: ${POSTGRES_USER:-strapi}
      HOST: 0.0.0.0
      JWT_SECRET: ${JWT_SECRET}
      NODE_ENV: production
      PORT: 1337
      STRAPI_ADMIN_CLIENT_PREVIEW_SECRET: ${STRAPI_ADMIN_CLIENT_PREVIEW_SECRET}
      STRAPI_ADMIN_CLIENT_URL: ${STRAPI_ADMIN_CLIENT_URL:-https://cv.kingkontext.nl}
      STRAPI_URL: ${STRAPI_URL:-https://cms.kingkontext.nl}
      TRANSFER_TOKEN_SALT: ${TRANSFER_TOKEN_SALT}
    healthcheck:
      interval: 30s
      retries: 3
      start_period: 60s
      test:
        - CMD
        - node
        - -e
        - >
          require('http').get('http://localhost:1337/_health', (r) => {
            const ok = r.statusCode >= 200 && r.statusCode < 300;
            process.exit(ok ? 0 : 1);
          }).on('error', () => process.exit(1));
      timeout: 10s
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.cms-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.cms-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.cms-http.entrypoints=web"
      - "traefik.http.routers.cms-http.middlewares=cms-https-redirect"
      - "traefik.http.routers.cms-http.rule=Host(`cms.kingkontext.nl`)"
      - "traefik.http.routers.cms-http.service=cms-svc"
      - "traefik.http.routers.cms.entrypoints=websecure"
      - "traefik.http.routers.cms.middlewares=cms-headers@docker"
      - "traefik.http.routers.cms.rule=Host(`cms.kingkontext.nl`)"
      - "traefik.http.routers.cms.service=cms-svc"
      - "traefik.http.routers.cms.tls.certresolver=lehttp"
      - "traefik.http.routers.cms.tls=true"
      - "traefik.http.services.cms-svc.loadbalancer.server.port=1337"
    networks:
      - kingkontext-nl-internal
      - proxy
    restart: unless-stopped
    volumes:
      - cms-uploads:/opt/app/apps/cms/public/uploads

  # CV Generator Worker (background job processor)
  cv-gen:
    image: ${REGISTRY_BASE_URL}kingkontext-nl-cv-gen:latest
    # build:
    #   context: ${APP_CODE_PATH}
    #   dockerfile: packages/cv-gen/Dockerfile
    container_name: kingkontext-nl-cv-gen
    depends_on:
      cms:
        condition: service_healthy
      tika:
        condition: service_started
    env_file:
      - .env
    environment:
      ASSIGNMENTS_DIR: /opt/app/markdown/assignments
      PROFILE_PATH: /opt/app/markdown/profile.md
      SKILLS_PATH: /opt/app/markdown/skills.md
      CV_GEN_WORKER_ID: ${CV_GEN_WORKER_ID:-kingkontext-worker-01}
      LLM_PROVIDER: ${LLM_PROVIDER:-openai}
      NODE_ENV: production
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      TOP_N_ASSIGNMENTS: ${TOP_N_ASSIGNMENTS}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4-turbo-preview}
      POLLING_INTERVAL_MS: ${POLLING_INTERVAL_MS:-15000}
      STRAPI_API_TOKEN: ${STRAPI_API_TOKEN}
      STRAPI_BASE_URL: http://cms:1337
      TIKA_URL: http://tika:9998/tika
    networks:
      - kingkontext-nl-internal
    restart: unless-stopped
    volumes:
      - ${APP_CODE_PATH}/markdown:/opt/app/markdown:ro

  # Offer Processor Worker (enriches offers and writes CV records)
  offer-processor:
    image: ${REGISTRY_BASE_URL}kingkontext-nl-offer-processor:${OFFER_PROCESSOR_IMAGE_TAG:-latest}
    # build:
    #   context: ${APP_CODE_PATH}
    #   dockerfile: packages/offer-processor/Dockerfile
    container_name: kingkontext-nl-offer-processor
    depends_on:
      cms:
        condition: service_healthy
      tika:
        condition: service_started
    env_file:
      - .env
    environment:
      ASSIGNMENTS_DIR: /opt/app/markdown/assignments
      PROFILE_PATH: /opt/app/markdown/profile.md
      SKILLS_PATH: /opt/app/markdown/skills.md
      OFFER_PROCESSOR_WORKER_ID: ${OFFER_PROCESSOR_WORKER_ID:-kingkontext-offer-processor-01}
      PROVIDER: ${PROVIDER:-openai}
      NODE_ENV: production
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-5.1}
      TOP_N_ASSIGNMENTS: ${TOP_N_ASSIGNMENTS:-3}
      MAX_CV_WORDS: ${MAX_CV_WORDS:-500}
      POLL_INTERVAL_MS: ${POLLING_INTERVAL_MS:-15000}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      STRAPI_API_TOKEN: ${STRAPI_API_TOKEN}
      STRAPI_BASE_URL: http://cms:1337
      TIKA_URL: http://tika:9998/tika
    networks:
      - kingkontext-nl-internal
    restart: unless-stopped
    volumes:
      - ${APP_CODE_PATH}/markdown:/opt/app/markdown:ro

  # Apache Tika (document text extraction)
  tika:
    image: apache/tika:latest-full
    container_name: kingkontext-nl-tika
    networks:
      - kingkontext-nl-internal
    restart: unless-stopped

  # PDF Export Worker (PDF generation service)
  pdf-export:
    image: ${REGISTRY_BASE_URL}kingkontext-nl-pdf-export:${PDF_EXPORT_IMAGE_TAG:-latest}
    # build:
    #   context: ${APP_CODE_PATH}
    #   dockerfile: packages/pdf-export/Dockerfile
    container_name: kingkontext-nl-pdf-export
    depends_on:
      cms:
        condition: service_healthy
    env_file:
      - .env
    environment:
      NODE_ENV: production
      STRAPI_API_TOKEN: ${STRAPI_API_TOKEN}
      STRAPI_URL: http://cms:1337
      NEXT_PUBLIC_STRAPI_URL: http://cms:1337
      POLL_INTERVAL_MS: ${PDF_EXPORT_POLL_INTERVAL_MS:-5000}
      ALLOW_PARALLEL: ${PDF_EXPORT_ALLOW_PARALLEL:-false}
      DEBUG: ${PDF_EXPORT_DEBUG:-}
    networks:
      - kingkontext-nl-internal
    restart: unless-stopped

  # Offer Finder Worker (crawls external providers for job offers)
  offer-finder:
    image: ${REGISTRY_BASE_URL}kingkontext-nl-offer-finder:${OFFER_FINDER_IMAGE_TAG:-latest}
    # build:
    #   context: ${APP_CODE_PATH}
    #   dockerfile: packages/offer-finder/Dockerfile
    container_name: kingkontext-nl-offer-finder
    depends_on:
      cms:
        condition: service_healthy
    env_file:
      - .env
    environment:
      NODE_ENV: production
      STRAPI_API_TOKEN: ${STRAPI_API_TOKEN}
      STRAPI_URL: http://cms:1337
      MODE: ${OFFER_FINDER_MODE:-daemon}
      POLL_INTERVAL_MS: ${OFFER_FINDER_POLL_INTERVAL_MS:-300000}
      PROCESS_SEARCHES: ${OFFER_FINDER_PROCESS_SEARCHES:-true}
      SEARCH_POLL_INTERVAL_MS: ${OFFER_FINDER_SEARCH_POLL_INTERVAL_MS:-30000}
      KEYWORDS: ${OFFER_FINDER_KEYWORDS:-}
      LOCATIONS: ${OFFER_FINDER_LOCATIONS:-}
      REMOTE_ONLY: ${OFFER_FINDER_REMOTE_ONLY:-false}
      SINK: ${OFFER_FINDER_SINK:-strapi}
      OUTPUT_DIR: ${OFFER_FINDER_OUTPUT_DIR:-/tmp/offers}
      HTTP_TIMEOUT_MS: ${OFFER_FINDER_HTTP_TIMEOUT_MS:-30000}
      HTTP_RETRY_LIMIT: ${OFFER_FINDER_HTTP_RETRY_LIMIT:-3}
      HTTP_RETRY_DELAY_MS: ${OFFER_FINDER_HTTP_RETRY_DELAY_MS:-1000}
      HTTP_THROTTLE_MS: ${OFFER_FINDER_HTTP_THROTTLE_MS:-1000}
      HTTP_USER_AGENT: ${OFFER_FINDER_HTTP_USER_AGENT:-OfferFinder/1.0}
      HEADFIRST_ENABLED: ${OFFER_FINDER_HEADFIRST_ENABLED:-true}
      HEADFIRST_BASE_URL: ${OFFER_FINDER_HEADFIRST_BASE_URL:-https://headfirst.nl}
      HEADFIRST_MAX_PAGES: ${OFFER_FINDER_HEADFIRST_MAX_PAGES:-5}
      HEADFIRST_DELAY_MS: ${OFFER_FINDER_HEADFIRST_DELAY_MS:-2000}
      HEADFIRST_INCLUDE_SIMILAR: ${OFFER_FINDER_HEADFIRST_INCLUDE_SIMILAR:-false}
      HEADFIRST_MODE: ${OFFER_FINDER_HEADFIRST_MODE:-public}
      LOG_LEVEL: ${OFFER_FINDER_LOG_LEVEL:-info}
    networks:
      - kingkontext-nl-internal
    restart: unless-stopped

  # Possibilities Discovery Worker (generates search ideas from assignments)
  possibilities-discovery:
    image: ${REGISTRY_BASE_URL}kingkontext-nl-possibilities-discovery:${POSSIBILITIES_DISCOVERY_IMAGE_TAG:-latest}
    # build:
    #   context: ${APP_CODE_PATH}
    #   dockerfile: packages/possibilities-discovery/Dockerfile
    container_name: kingkontext-nl-possibilities-discovery
    depends_on:
      cms:
        condition: service_healthy
    env_file:
      - .env
    environment:
      ASSIGNMENTS_DIR: /opt/app/markdown/assignments
      NODE_ENV: production
      STRAPI_API_TOKEN: ${STRAPI_API_TOKEN}
      STRAPI_URL: http://cms:1337
      MODE: ${POSSIBILITIES_DISCOVERY_MODE:-daemon}
      POLL_INTERVAL_MS: ${POSSIBILITIES_DISCOVERY_POLL_INTERVAL_MS:-600000}
      PROVIDER: ${POSSIBILITIES_DISCOVERY_PROVIDER:-openai}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${POSSIBILITIES_DISCOVERY_OPENAI_MODEL:-gpt-4o-mini}
      TEMPERATURE: ${POSSIBILITIES_DISCOVERY_TEMPERATURE:-0.7}
      MAX_TOKENS: ${POSSIBILITIES_DISCOVERY_MAX_TOKENS:-1000}
      HTTP_TIMEOUT_MS: ${POSSIBILITIES_DISCOVERY_HTTP_TIMEOUT_MS:-30000}
      LOG_LEVEL: ${POSSIBILITIES_DISCOVERY_LOG_LEVEL:-info}
    networks:
      - kingkontext-nl-internal
    restart: unless-stopped
    volumes:
      - ${APP_CODE_PATH}/markdown:/opt/app/markdown:ro

  # Next.js Web Application
  web:
    image: ${REGISTRY_BASE_URL}kingkontext-nl-web:latest
    # build:
    #   context: ${APP_CODE_PATH}
    #   dockerfile: apps/web/Dockerfile
    container_name: kingkontext-nl-web
    depends_on:
      cms:
        condition: service_healthy
    env_file:
      - .env
    environment:
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
      N8N_OFFER_WEBHOOK_URL: ${N8N_OFFER_WEBHOOK_URL}
      NEXT_PUBLIC_STRAPI_URL: ${NEXT_PUBLIC_STRAPI_URL:-https://cms.kingkontext.nl}
      NEXT_PUBLIC_URL: ${NEXT_PUBLIC_URL:-https://cv.kingkontext.nl}
      NODE_ENV: production
      STRAPI_API_TOKEN: ${STRAPI_API_TOKEN}
      STRAPI_URL: ${STRAPI_URL:-https://cms.kingkontext.nl}
    healthcheck:
      interval: 30s
      retries: 3
      start_period: 40s
      test:
        - CMD
        - node
        - -e
        - >
          require('http').get('http://localhost:3000/api/health', (r) => {
            const ok = r.statusCode >= 200 && r.statusCode < 300;
            process.exit(ok ? 0 : 1);
          }).on('error', () => process.exit(1));
      timeout: 10s
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.web-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.web-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.web-http.entrypoints=web"
      - "traefik.http.routers.web-http.middlewares=web-https-redirect"
      - "traefik.http.routers.web-http.rule=Host(`cv.kingkontext.nl`)"
      - "traefik.http.routers.web-http.service=web-svc"
      - "traefik.http.routers.web.entrypoints=websecure"
      - "traefik.http.routers.web.middlewares=web-headers@docker"
      - "traefik.http.routers.web.rule=Host(`cv.kingkontext.nl`)"
      - "traefik.http.routers.web.service=web-svc"
      - "traefik.http.routers.web.tls.certresolver=lehttp"
      - "traefik.http.routers.web.tls=true"
      - "traefik.http.services.web-svc.loadbalancer.server.port=3000"
    networks:
      - kingkontext-nl-internal
      - proxy
    restart: unless-stopped
    volumes:
      - web-cache:/app/.next/cache

networks:
  kingkontext-nl-internal:
    driver: bridge
  proxy:
    external: true

volumes:
  cms-uploads:
    driver: local
  postgres-data:
    driver: local
  web-cache:
    driver: local
