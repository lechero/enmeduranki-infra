services:
  registry:
    image: registry:2
    container_name: sippar-registry
    restart: unless-stopped
    env_file:
      - .env
    environment:
      REGISTRY_HTTP_SECRET: ${REGISTRY_HTTP_SECRET}
      REGISTRY_STORAGE_DELETE_ENABLED: ${REGISTRY_STORAGE_DELETE_ENABLED:-false}
      REGISTRY_AUTH: htpasswd
      REGISTRY_AUTH_HTPASSWD_REALM: "Registry Realm"
      REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
    volumes:
      - "${REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY}:/var/lib/registry"
      - "${REGISTRY_AUTH_FILE_DIRECTORY:-/var/lib/registry/auth}:/auth:ro"
    labels:
      - "traefik.enable=true"

      # HTTPS
      - "traefik.http.routers.registry.rule=Host(`${REGISTRY_DOMAIN}`)"
      - "traefik.http.routers.registry.entrypoints=websecure"
      - "traefik.http.routers.registry.tls=true"
      - "traefik.http.routers.registry.tls.certresolver=lehttp"
      - "traefik.http.routers.registry.service=registry-svc"

      # HTTP â†’ HTTPS redirect
      - "traefik.http.routers.registry-http.rule=Host(`${REGISTRY_DOMAIN}`)"
      - "traefik.http.routers.registry-http.entrypoints=web"
      - "traefik.http.routers.registry-http.middlewares=registry-https-redirect"
      - "traefik.http.middlewares.registry-https-redirect.redirectscheme.scheme=https"

      # Middleware: optional HSTS
      - "traefik.http.middlewares.registry-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.registry-auth.basicauth.usersfile=/auth/htpasswd"
      - "traefik.http.routers.registry.middlewares=registry-headers@docker,registry-auth@docker"

      # Port mapping
      - "traefik.http.services.registry-svc.loadbalancer.server.port=5000"

    networks:
      - proxy

networks:
  proxy:
    external: true
